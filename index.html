<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Habit Garden</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --primary: #27ae60; /* æ¤ç‰©ã®ç·‘ */
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            padding-top: 50px;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- æ¤ç‰©ã‚¨ãƒªã‚¢ --- */
        .garden-container {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .plant-emoji {
            font-size: 80px;
            display: block;
            margin-bottom: 10px;
            animation: bounce 3s infinite ease-in-out;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .level-text {
            font-size: 15px;
            color: #7f8c8d;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        /* çµŒé¨“å€¤ãƒãƒ¼ */
        .exp-bar-bg {
            width: 80%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 15px auto 5px;
            overflow: hidden;
        }
        .exp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .total-count {
            font-size: 12px;
            color: #bdc3c7;
        }

        /* --- ç¿’æ…£ã‚«ãƒ¼ãƒ‰ --- */
        .habit-card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            transition: transform 0.1s;
        }
        .habit-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .habit-name {
            font-weight: 700;
            font-size: 18px;
        }
        
        /* ã‚¹ã‚¤ãƒƒãƒãƒœã‚¿ãƒ³ */
        .toggle-btn {
            width: 52px;
            height: 32px;
            background: #dfe4ea;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toggle-btn::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* ONã®çŠ¶æ…‹ */
        .toggle-btn.active {
            background: var(--primary);
        }
        .toggle-btn.active::after {
            transform: translateX(20px);
        }

        /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ --- */
        .streak-info {
            font-size: 12px;
            color: #95a5a6;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 1é€±é–“åˆ† */
            gap: 6px;
        }
        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 6px;
            background: #f7f9fa;
            color: #cbd5e0;
            font-weight: 600;
        }
        .cal-day.done {
            background: #2ecc71;
            color: white;
            box-shadow: 0 2px 4px rgba(46, 204, 113, 0.2);
        }
        .cal-day.today {
            border: 2px solid #34495e;
            box-sizing: border-box; /*æ ç·šã‚’å«ã‚ã¦ã‚µã‚¤ã‚ºè¨ˆç®—*/
        }
    </style>
</head>
<body>

    <div class="garden-container">
        <div id="plant-icon" class="plant-emoji">ğŸŒ±</div>
        <div id="garden-message" class="level-text">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="exp-bar-bg">
            <div id="exp-bar" class="exp-bar-fill"></div>
        </div>
        <p class="total-count">Total Completed: <span id="total-count">0</span></p>
    </div>

    <div id="habit-list"></div>

    <script>
        // â–¼â–¼â–¼ ã‚ãªãŸã®æ–°ã—ã„ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’åŸ‹ã‚è¾¼ã¿ã¾ã—ãŸ â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-gjPZTKo2-9F8IpCksFjn-BkpC6yPYv0eHOgyM1ZollaZAc8E1K_agL-HvvP243be/exec";

        const listContainer = document.getElementById('habit-list');
        const todayStr = new Date().toISOString().split('T')[0]; // "2024-01-06"
        let habitsData = [];

        // æ¤ç‰©ã®é€²åŒ–ãƒ‡ãƒ¼ã‚¿
        const plantLevels = [
            { threshold: 0, icon: "ğŸŒ±", title: "ç¨®ã¾ã (Sprout)" },
            { threshold: 5, icon: "ğŸŒ¿", title: "åŒè‘‰ (Seedling)" },
            { threshold: 15, icon: "ğŸª´", title: "é‰¢æ¤ãˆ (Potted)" },
            { threshold: 30, icon: "ğŸŒ³", title: "è‹¥æœ¨ (Sapling)" },
            { threshold: 50, icon: "ğŸ", title: "å®Ÿã‚Š (Fruiting)" },
            { threshold: 100, icon: "ğŸ°", title: "å¤§æ¨¹ (Elder Tree)" }
        ];

        // 1. ãƒ‡ãƒ¼ã‚¿å–å¾—
        async function fetchHabits() {
            try {
                const res = await fetch(SCRIPT_URL);
                if (!res.ok) throw new Error("Network response was not ok");
                
                // HTMLãŒè¿”ã£ã¦ãã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ¨©é™ã‚¨ãƒ©ãƒ¼å¯¾ç­–ï¼‰
                const text = await res.text();
                if (text.startsWith("<")) throw new Error("Auth Error");
                
                habitsData = JSON.parse(text);
                renderAll();
                updateGarden();
            } catch (e) {
                console.error(e);
                document.getElementById('garden-message').textContent = "Connection Error";
                // ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ç†ç”±ã‚’å°‘ã—è©³ã—ãå‡ºã™
                const list = document.getElementById('habit-list');
                list.innerHTML = `<p style="text-align:center;color:red;font-size:12px;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>GASã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã€Œå…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ã€<br>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®1è¡Œç›®Cåˆ—ãŒ<br>ã€Œhistoryã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
            }
        }

        // 2. å…¨ä½“æç”»
        function renderAll() {
            listContainer.innerHTML = '';
            habitsData.forEach(habit => {
                // ä»Šæ—¥ã®æ—¥ä»˜ãŒå±¥æ­´ã«ã‚ã‚‹ã‹ï¼Ÿ
                const isDoneToday = habit.history.includes(todayStr);
                
                const card = document.createElement('div');
                card.className = 'habit-card';

                // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨
                const header = document.createElement('div');
                header.className = 'habit-header';
                
                const name = document.createElement('div');
                name.className = 'habit-name';
                name.textContent = habit.name;

                const toggle = document.createElement('div');
                toggle.className = `toggle-btn ${isDoneToday ? 'active' : ''}`;
                toggle.onclick = () => toggleHabit(habit.id); // ã‚¯ãƒªãƒƒã‚¯æ™‚å‡¦ç†

                header.appendChild(name);
                header.appendChild(toggle);
                card.appendChild(header);

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼éƒ¨
                const streakInfo = document.createElement('div');
                streakInfo.className = 'streak-info';
                streakInfo.textContent = `ã“ã‚Œã¾ã§ã®ç©ã¿ä¸Šã’: ${habit.history.length}æ—¥`;
                
                const calendar = createMiniCalendar(habit.history);
                
                card.appendChild(streakInfo);
                card.appendChild(calendar);
                listContainer.appendChild(card);
            });
        }

        // 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆï¼ˆéå»13æ—¥ï¼‹ä»Šæ—¥ï¼‰
        function createMiniCalendar(history) {
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';

            // éå»13æ—¥å‰ã‹ã‚‰ä»Šæ—¥(0)ã¾ã§ãƒ«ãƒ¼ãƒ—
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const dayNum = d.getDate();
                
                const cell = document.createElement('div');
                let cellClass = 'cal-day';
                
                if (history.includes(dateStr)) cellClass += ' done';
                if (i === 0) cellClass += ' today'; // ä»Šæ—¥ã‚’å¼·èª¿

                cell.className = cellClass;
                cell.textContent = dayNum;
                
                grid.appendChild(cell);
            }
            return grid;
        }

        // 4. æ¤ç‰©ã®æˆé•·æ›´æ–°
        function updateGarden() {
            let totalDone = 0;
            habitsData.forEach(h => totalDone += h.history.length);

            // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã‚’åˆ¤å®š
            let currentLevel = plantLevels[0];
            let nextThreshold = 100;

            for (let i = 0; i < plantLevels.length; i++) {
                if (totalDone >= plantLevels[i].threshold) {
                    currentLevel = plantLevels[i];
                    // æ¬¡ã®ç›®æ¨™å€¤
                    if (plantLevels[i+1]) {
                        nextThreshold = plantLevels[i+1].threshold;
                    } else {
                        nextThreshold = totalDone * 1.5; // ä¸Šé™è¶…ãˆãŸã‚‰é©å½“ã«
                    }
                }
            }

            document.getElementById('plant-icon').textContent = currentLevel.icon;
            document.getElementById('garden-message').textContent = `Lv.${Math.floor(totalDone/5)+1} ${currentLevel.title}`;
            document.getElementById('total-count').textContent = totalDone;

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
            const progress = Math.min(100, (totalDone / nextThreshold) * 100);
            document.getElementById('exp-bar').style.width = `${progress}%`;
        }

        // 5. ãƒ‡ãƒ¼ã‚¿æ›´æ–°å‡¦ç†
        async function toggleHabit(id) {
            const habit = habitsData.find(h => h.id === id);
            const isDone = habit.history.includes(todayStr);

            // â‘  UIã‚’å³æ™‚æ›´æ–°ï¼ˆã‚µã‚¯ã‚µã‚¯æ„Ÿï¼‰
            if (isDone) {
                // å‰Šé™¤
                habit.history = habit.history.filter(d => d !== todayStr);
            } else {
                // è¿½åŠ 
                habit.history.push(todayStr);
                // é”æˆæ™‚ã®ã¿ç´™å¹é›ªï¼
                confetti({ particleCount: 60, spread: 70, origin: { y: 0.7 } });
            }

            renderAll();
            updateGarden();

            // â‘¡ è£å´ã§é€ä¿¡
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ 
                        id: habit.id, 
                        date: todayStr, 
                        done: !isDone // åè»¢ã•ã›ãŸçµæœã‚’é€ã‚‹
                    })
                });
            } catch (e) {
                console.error("Save Error", e);
            }
        }

        // é–‹å§‹
        fetchHabits();
    </script>
</body>
</html>